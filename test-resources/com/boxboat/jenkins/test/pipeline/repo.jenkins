@Library('jenkins-shared-library@master')
import com.boxboat.jenkins.pipeline.*


def execute() {
    node() {

        def repo = new BoxBuild(
            pipeline: this,
            config: [
                composeProfileMap: [
                    "dev" : "./build/docker/dev/",
                    "prod": "./build/docker/prod/",
                ],
            ],
        )

        try {
          stage('Setup') {
            repo.init()
            repo.composeUp("dev")
          }
          stage('Test'){
            sh './build/ci/test.sh'
            sh './build/ci/test-api.sh'
          }
          stage('Build'){
            repo.composeUp("prod")
          }
          stage ('Push'){
            repo.push()
          }
          repo.success()
        } catch (Exception ex) {
          repo.failure(ex)
          throw ex
        } finally {
          stage('Cleanup'){
            repo.cleanup()
          }
        }

    }
}

return this